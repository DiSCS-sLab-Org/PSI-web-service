<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSI Service - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-size: 1.5rem;
        }

        .user-menu {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .card h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            transition: border-color 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        #fileInput {
            display: none;
        }

        .file-info {
            margin: 1rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
            display: none;
        }

        .progress {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 1rem 0;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .results {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            border-radius: 0 5px 5px 0;
        }

        .results.error {
            background: #ffeaea;
            border-left-color: #dc3545;
        }

        .sessions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .sessions-table th,
        .sessions-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .sessions-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .sessions-table tbody tr:hover {
            background: #f8f9fa;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .download-btn:hover {
            background: #218838;
        }

        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <h1>üîí PSI Service Dashboard</h1>
        </div>
        <div class="user-menu">
            <span id="userInfo">User</span>
            <span id="adminBadge" style="display: none; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 3px; font-size: 0.8rem; margin-left: 0.5rem;">Admin</span>
            <button class="btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- PSI Computation Section -->
        <div class="card">
            <h2>üîç Private Set Intersection</h2>
            <p>Upload your IP list to find intersections with the server's threat intelligence database.</p>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div id="uploadContent">
                    <p><strong>Click to upload</strong> or drag and drop your file here</p>
                    <p>Supported format: Text file with one IP address per line</p>
                </div>
            </div>

            <input type="file" id="fileInput" accept=".txt,.csv" onchange="handleFileSelect(event)">

            <div class="file-info" id="fileInfo">
                <p><strong>File:</strong> <span id="fileName"></span></p>
                <p><strong>Size:</strong> <span id="fileSize"></span></p>
                <p><strong>IPs Found:</strong> <span id="ipCount"></span></p>
            </div>

            <div class="progress" id="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <button class="btn btn-primary" id="computeBtn" onclick="computePSI()" disabled style="margin-top: 1rem;">
                Compute Intersection
            </button>

            <div class="results" id="results"></div>
        </div>

        <!-- Session History -->
        <div class="card">
            <h2>üìä Session History</h2>
            <div id="sessionsContent">
                <div class="loading">Loading sessions...</div>
            </div>
        </div>

        <!-- Admin Panel (only shown for admin users) -->
        <div class="card" id="adminPanel" style="display: none;">
            <h2>üîß Admin Panel</h2>
            <p>View all user sessions across the system.</p>
            <div id="adminSessionsContent">
                <div class="loading">Loading all sessions...</div>
            </div>
        </div>
    </div>

    <script type="module">
        let currentToken = localStorage.getItem('psi_token');
        let currentUserRole = localStorage.getItem('psi_user_role');
        let clientData = [];
        let psiClient = null;
        let PSI = null;

        // Check authentication - if no token, redirect to login
        if (!currentToken) {
            window.location.href = '/login';
        }

        // Load OpenMined PSI WebAssembly module locally
        async function initPSI() {
            try {
                // Load OpenMined PSI WASM module from local server using script tag
                // The PSI module sets window.PSI as a global variable
                if (window.PSI) {
                    // PSI is already loaded
                    PSI = window.PSI;
                    console.log('‚úÖ PSI WebAssembly module already loaded');
                    return true;
                }

                // Dynamically load the PSI module
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = '/static/js/psi_wasm_web.js';
                    script.onload = async () => {
                        try {
                            // Wait for PSI global to be available and initialize
                            if (window.PSI && typeof window.PSI === 'function') {
                                PSI = await window.PSI();
                                console.log('‚úÖ PSI WebAssembly module loaded successfully');
                                resolve(true);
                            } else {
                                reject(new Error('PSI global not found'));
                            }
                        } catch (error) {
                            console.error('‚ùå Failed to initialize PSI:', error);
                            reject(error);
                        }
                    };
                    script.onerror = () => reject(new Error('Failed to load PSI script'));
                    document.head.appendChild(script);
                });
            } catch (error) {
                console.error('‚ùå Failed to load PSI module:', error);
                return false;
            }
        }

        // File handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const ips = content.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && isValidIP(line));

                clientData = ips;

                // Update UI
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = formatBytes(file.size);
                document.getElementById('ipCount').textContent = ips.length;
                document.getElementById('fileInfo').style.display = 'block';
                document.getElementById('computeBtn').disabled = ips.length === 0;

                if (ips.length === 0) {
                    showResults('No valid IP addresses found in the file.', true);
                }
            };
            reader.readAsText(file);
        }

        function isValidIP(ip) {
            const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            return ipRegex.test(ip);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // True Privacy-Preserving Client-Side PSI using WebAssembly
        async function computePSI() {
            if (clientData.length === 0) return;

            const computeBtn = document.getElementById('computeBtn');
            const progress = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');

            computeBtn.disabled = true;
            computeBtn.textContent = 'Computing...';
            progress.style.display = 'block';

            try {
                if (!PSI) {
                    throw new Error('PSI WebAssembly module not loaded. Please refresh the page.');
                }

                // Step 1: Create PSI client (privacy-preserving)
                progressBar.style.width = '20%';
                const revealIntersection = true; // We want to see the actual IPs
                const psiClient = PSI.client.createWithNewKey(revealIntersection);

                // Step 2: Get server setup
                progressBar.style.width = '40%';
                const setupResponse = await fetch(`/setup?num_client_inputs=${clientData.length}&container=raw&fpr=1e-9`);
                if (!setupResponse.ok) {
                    throw new Error('Failed to get server setup');
                }
                const setupHex = await setupResponse.text();

                // Parse server setup from hex
                const setupBytes = new Uint8Array(setupHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                const serverSetup = PSI.serverSetup.deserializeBinary(setupBytes);

                // Step 3: Create client request (encrypted, no raw data sent)
                progressBar.style.width = '60%';
                const clientRequest = psiClient.createRequest(clientData);

                // Step 4: Send encrypted request to server
                progressBar.style.width = '80%';
                const requestBytes = clientRequest.serializeBinary();
                const requestHex = Array.from(requestBytes, byte => byte.toString(16).padStart(2, '0')).join('');

                const processResponse = await fetch('/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ request_hex: requestHex })
                });

                if (!processResponse.ok) {
                    throw new Error('Failed to process PSI request');
                }

                // Step 5: Get server response and compute intersection client-side
                const responseHex = await processResponse.text();
                const responseBytes = new Uint8Array(responseHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                const serverResponse = PSI.response.deserializeBinary(responseBytes);

                progressBar.style.width = '90%';

                // Compute intersection indices (client-side only)
                const intersectionIndices = psiClient.getIntersection(serverSetup, serverResponse);
                const intersectionIps = intersectionIndices.map(idx => clientData[idx]);

                progressBar.style.width = '100%';

                // Step 6: Log results to server (only metadata, no raw IPs)
                const formData = new FormData();
                formData.append('client_size', clientData.length);
                formData.append('intersection_size', intersectionIps.length);
                formData.append('intersection_data', JSON.stringify(intersectionIps));

                const logResponse = await fetch('/api/log-psi-result', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: formData
                });

                let sessionId = 'unknown';
                if (logResponse.ok) {
                    const logResult = await logResponse.json();
                    sessionId = logResult.session_id;
                }

                showResults(`
                    <h3>üîí Privacy-Preserving PSI Complete</h3>
                    <p><strong>Your IPs:</strong> ${clientData.length}</p>
                    <p><strong>Intersection Found:</strong> ${intersectionIps.length} IPs</p>
                    <p><strong>Session ID:</strong> ${sessionId}</p>
                    ${intersectionIps.length > 0 ? '<p>‚ö†Ô∏è Some of your IPs are in the threat intelligence database!</p>' : '<p>‚úÖ None of your IPs are in the threat intelligence database.</p>'}
                    ${intersectionIps.length > 0 ? `<p><strong>Matching IPs:</strong> ${intersectionIps.slice(0, 10).join(', ')}${intersectionIps.length > 10 ? '...' : ''}</p>` : ''}
                    <p><small>üõ°Ô∏è Your raw IP list never left your browser</small></p>
                `);

                // Refresh sessions
                loadSessions();

            } catch (error) {
                console.error('PSI computation failed:', error);
                showResults(`Privacy-preserving PSI failed: ${error.message}<br><br>
                    <strong>Fallback:</strong> For guaranteed privacy-preserving PSI, use the CLI client:<br>
                    <code>./psi_client.sh your_file.txt</code>`, true);
            }

            computeBtn.disabled = false;
            computeBtn.textContent = 'Compute Intersection';
            progress.style.display = 'none';
            progressBar.style.width = '0%';
        }

        function showResults(message, isError = false) {
            const results = document.getElementById('results');
            results.innerHTML = message;
            results.className = `results ${isError ? 'error' : ''}`;
            results.style.display = 'block';
        }

        // Session management
        async function loadSessions() {
            // Don't try to load sessions if no token
            if (!currentToken) {
                document.getElementById('sessionsContent').innerHTML = '<p>No authentication token found.</p>';
                return;
            }

            try {
                const response = await fetch('/api/sessions', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displaySessions(data.sessions);
                } else if (response.status === 401) {
                    // Token is invalid, clear it and redirect
                    localStorage.removeItem('psi_token');
                    localStorage.removeItem('psi_user_role');
                    window.location.href = '/login';
                } else {
                    document.getElementById('sessionsContent').innerHTML = '<p>Failed to load sessions.</p>';
                }
            } catch (error) {
                console.error('Failed to load sessions:', error);
                document.getElementById('sessionsContent').innerHTML = '<p>Error loading sessions.</p>';
            }
        }

        function displaySessions(sessions) {
            const content = document.getElementById('sessionsContent');

            if (sessions.length === 0) {
                content.innerHTML = '<p>No sessions found. Run your first PSI computation above!</p>';
                return;
            }

            const table = `
                <table class="sessions-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Your IPs</th>
                            <th>Intersection</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sessions.map(session => `
                            <tr>
                                <td>${new Date(session.timestamp).toLocaleString()}</td>
                                <td>${session.client_size}</td>
                                <td>${session.intersection_size}</td>
                                <td>
                                    <span class="status ${session.intersection_size > 0 ? 'warning' : 'success'}">
                                        ${session.intersection_size > 0 ? 'Threats Found' : 'Clean'}
                                    </span>
                                </td>
                                <td>
                                    <button class="download-btn" onclick="downloadSession(${session.id})">
                                        Download
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            content.innerHTML = table;
        }

        async function downloadSession(sessionId) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}/download`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `psi_results_${sessionId}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to download session results.');
                }
            } catch (error) {
                console.error('Download failed:', error);
                alert('Download failed. Please try again.');
            }
        }

        async function loadAdminSessions() {
            if (currentUserRole !== 'admin' || !currentToken) return;

            try {
                const response = await fetch('/api/admin/sessions', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayAdminSessions(data.sessions);
                } else if (response.status === 403) {
                    document.getElementById('adminSessionsContent').innerHTML = '<p>Access denied.</p>';
                } else {
                    document.getElementById('adminSessionsContent').innerHTML = '<p>Failed to load admin sessions.</p>';
                }
            } catch (error) {
                console.error('Failed to load admin sessions:', error);
                document.getElementById('adminSessionsContent').innerHTML = '<p>Error loading admin sessions.</p>';
            }
        }

        function displayAdminSessions(sessions) {
            const content = document.getElementById('adminSessionsContent');

            if (sessions.length === 0) {
                content.innerHTML = '<p>No sessions found across all users.</p>';
                return;
            }

            const table = `
                <table class="sessions-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Date</th>
                            <th>Client IPs</th>
                            <th>Intersection</th>
                            <th>Client IP</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sessions.map(session => `
                            <tr>
                                <td><strong>${session.username}</strong></td>
                                <td>${new Date(session.timestamp).toLocaleString()}</td>
                                <td>${session.client_size}</td>
                                <td>${session.intersection_size}</td>
                                <td>${session.client_ip}</td>
                                <td>
                                    <span class="status ${session.intersection_size > 0 ? 'warning' : 'success'}">
                                        ${session.intersection_size > 0 ? 'Threats Found' : 'Clean'}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            content.innerHTML = table;
        }

        function logout() {
            localStorage.removeItem('psi_token');
            localStorage.removeItem('psi_user_role');
            window.location.href = '/';
        }

        // Drag and drop handling
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });


        // Initialize
        window.handleFileSelect = handleFileSelect;
        window.computePSI = computePSI;
        window.downloadSession = downloadSession;
        window.logout = logout;

        // Initialize UI and load appropriate data based on user
        function initializeApp() {
            initPSI();

            // Only load sessions if user is authenticated
            if (currentToken) {
                loadSessions();  // Load user's own sessions

                // Load admin data if user is admin
                if (currentUserRole === 'admin') {
                    document.getElementById('adminBadge').style.display = 'inline-block';
                    document.getElementById('adminPanel').style.display = 'block';
                    loadAdminSessions();
                }
            }
        }

        // Initialize app
        initializeApp();
    </script>
</body>
</html>